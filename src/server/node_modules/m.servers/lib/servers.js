
const request = require('request');
const defRequestHeader = require('m.config').requestHeader;
const config = require('m.config');
const baseUrl = config.servers[config.G.env];

const get = (url) => (data = {}) => {

  let requestHeader = Object.assign({}, defRequestHeader);

      requestHeader.headers.uid = data.uid || "";
      requestHeader.headers.accessToken = data.accessToken || data.token || "";

  delete data.uid;
  delete data.accessToken;

  let params = Object.keys(data).map(function (key) {
    return encodeURIComponent(key) + "=" + encodeURIComponent(data[key]);
  }).join("&");

  let reqUrl = `${baseUrl}${url}?${params}`;

  requestHeader.url = reqUrl;

  log.debug(requestHeader);
  console.log("requestHeader >>>>>>")
  console.log(requestHeader)

  return new Promise((resolve, reject) => {
    request(requestHeader, function (error, response, body) {

      if (!error && response.statusCode == 200) {

        // 进入返回日志
        log.debug(body);
        let d = Object.assign({}, {"data": body}, {code: 0});

        resolve(d);
      } else {

        // 进入错误日志
        log.error(`请求资源：${reqUrl} >>>>> 错误信息：${error}`);
        console.log(error)

        let d = Object.assign({}, {"data": error}, {code: -2});
        resolve(d);
        //reject(error);
      }
    });
  });
}

const post = (url) => (data = {}) => {

  let requestHeader = Object.assign({}, defRequestHeader);
      requestHeader.url = baseUrl+url;

  log.debug(requestHeader);
  log.debug(data);

  return new Promise((resolve, reject) => {

    request.post(requestHeader, function(error, response, body){

      if(!error) {

        // 进入返回日志
        log.debug(body);

        let d = Object.assign({}, {"data": body}, {code: 0});
        resolve(d);
      } else {

        // 进入错误日志
        log.error(`请求资源：${requestHeader} >>>>> 错误信息：${error}`);
        let d = Object.assign({}, {"data": error}, {code: -2});
        resolve(d);
        //reject(d);
      }
    }).json(data);
  });
}

module.exports = {
  get,
  post,
};
